<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<title>Mapa dos Pólos UAB</title>
	<meta charset="utf-8">
	<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
	<script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<script src="ipes-all.json" type="text/javascript"></script>

<script src=" https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>


	<style type="text/css" charset="utf-8">
		#map {
			height: 500px;
			margin-left:auto;
			margin-right:auto;
			width:50%;
			border-style: solid;
			border-color: #555;
			border-width: 5px;
			-moz-border-radius: 10px;
			border-radius: 10px;
		}
	</style>
</head>
<body>

	<div id="map"></div><br>

	<script>
	regioes = {
    "AC" : "Norte",
    "AL" : "Nordeste",
    "AP" : "Norte",
    "AM" : "Norte",
    "BA" : "Nordeste",
    "CE"  : "Nordeste",
    "DF"  : "Centro-Oeste",
    "ES"  : "Sudeste",
    "GO"  : "Centro-Oeste",
    "MA"  : "Nordeste",
    "MS"  : "Centro-Oeste",
    "MT"  : "Centro-Oeste",
    "MG"  : "Sudeste",
    "PA"  : "Norte",
    "PB"  : "Nordeste",
    "PR"  : "Sul",
    "PE"  : "Nordeste",
    "PI"  : "Nordeste",
    "RJ"  : "Sudeste",
    "RN"  : "Nordeste",
    "RS"  : "Sul",
    "RO"  : "Norte",
    "RR"  : "Norte",
    "SC"  : "Sul",
    "SP"  : "Sudeste",
    "SE"  : "Nordeste",
    "TO"  : "Norte"}


	//Cores para serem usadas no chart
	Colors = {};
Colors.names = {
    aqua: "#00ffff",
    azure: "#f0ffff",
    beige: "#f5f5dc",
    black: "#000000",
    blue: "#0000ff",
    brown: "#a52a2a",
    cyan: "#00ffff",
    darkblue: "#00008b",
    darkcyan: "#008b8b",
    darkgrey: "#a9a9a9",
    darkgreen: "#006400",
    darkkhaki: "#bdb76b",
    darkmagenta: "#8b008b",
    darkolivegreen: "#556b2f",
    darkorange: "#ff8c00",
    darkorchid: "#9932cc",
    darkred: "#8b0000",
    darksalmon: "#e9967a",
    darkviolet: "#9400d3",
    fuchsia: "#ff00ff",
    gold: "#ffd700",
    green: "#008000",
    indigo: "#4b0082",
    khaki: "#f0e68c",
    lightblue: "#add8e6",
    lightcyan: "#e0ffff",
    lightgreen: "#90ee90",
    lightgrey: "#d3d3d3",
    lightpink: "#ffb6c1",
    lightyellow: "#ffffe0",
    lime: "#00ff00",
    magenta: "#ff00ff",
    maroon: "#800000",
    navy: "#000080",
    olive: "#808000",
    orange: "#ffa500",
    pink: "#ffc0cb",
    purple: "#800080",
    violet: "#800080",
    red: "#ff0000",
    silver: "#c0c0c0",
    white: "#ffffff",
    yellow: "#ffff00"
};

Colors.random = function() {
    var result;
    var count = 0;

    for (var prop in this.names)
        if (Math.random() < 1/++count)
           result = prop;

		delete this.names[result];

    return result;
};

	var base = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
	  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	  });

	var brasil = L.geoJson(null, {
		style: {
			weight: 1,
			color: "#fff",
			opacity: 1,
			fillColor: "#ccc",
			fillOpacity: 1
			}
			});
			$.getJSON("br_estados.json", function(data) {
				brasil.addData(data);
			});


	var polosRegiao = {};
	var dadosChart = [];

	var ipes = L.geoJson(null, {onEachFeature: onEachFeature, pointToLayer: pointToLayer});
	$.getJSON("ipes-all.json", function (data) {
	  ipes.addData(data);

		//Todo esse código abaixo é necessário para se gerar o gráfico de pizza

		$.each(data.features, function (key, val) {
			//se não existe esse estado na lista cria
			if (!(regioes[val.properties.Estado] in polosRegiao)) {
				polosRegiao[regioes[val.properties.Estado]] = 1;
			}
			//se existe, soma ao valor
			polosRegiao[regioes[val.properties.Estado]] ++ ;

		});

		$.each(polosRegiao, function (regiao, qtde) {
			dadosChart.push({
				"label": regiao,
				"value": qtde,
				"color": Colors.random()
			});
		});

	});


//Versão polos por estado em pizza
	function polosPorEstado (myBarChart){
		var polosEstado = {};

		$.getJSON("ipes-all.json", function (data) {
			$.each(data.features, function (key, val) {
				//se não existe esse estado na lista cria
				if (!(val.properties.Estado in polosEstado)) {
					polosEstado[val.properties.Estado] = 1;
				}
				//se existe, soma ao valor
				polosEstado[val.properties.Estado] ++ ;

			});

			$.each(polosEstado, function (estado, qtde) {
				myBarChart.addData([qtde],estado);
			});
			myBarChart.update();

		});
}




  function onEachFeature (feature, marker) {
		if (feature.properties) {
			marker.bindPopup(
				'<b>' + feature.properties.Sigla + '</b>' + '<br>' +
				feature.properties.Cidade + ', ' + feature.properties.Estado + '</br>' +
				feature.properties.Logradouro + ' - ' + feature.properties.Bairro + '</br>' +
				feature.properties.CEP + '</br>' +
				'Telefone :' + feature.properties.Telefone + '</br>' +
				'<a href="' + feature.properties.URL + '">' + feature.properties.URL + '</a>'
			)
		}
	};

	function pointToLayer (feature, latlng) {
		 return L.circleMarker(latlng, {
			 radius: 6,
			 fillColor: "#267FCA", color: "#000",
			 weight: 1,
			 opacity: 1,
			 fillOpacity: 0.3
		 });
	 };

var map = L.map('map', {layers: [base,ipes]}).setView(new L.LatLng(-14.953349393643416,-52.220703125),4);

var baseMaps = {"Mapa": brasil};
var overlayMaps = {
	"Brasil" :brasil,
	"IPES" : ipes
};

//Ordem de camadas de vetores só será resolvida no Leaflet v1.0. Por isso a camada das
//zIndex() e bringToFront() não funcionam com vetores.
//Confirmado problema. Verificar também: http://gis.stackexchange.com/questions/166252/geojson-layer-order-in-leaflet-0-7-5
L.control.layers(baseMaps, overlayMaps,{position: 'topleft'}).addTo(map);
</script>

<div>
<!-- Gráfico de Barras-->
<canvas id="chartByState" width="800" height="300"></canvas>
</div>

<div>
<!--O código à seguir também é necessário para o gráfico de pizza -->
<canvas id="chartByRegion" width="400" height="400"></canvas>
</div>


<script>

window.onload = function(){
		//for bar grpah
		initialData = {
			labels : [],
			datasets :[{
				fillColor: "blue",
				data :[]
			}]

		};
		var ctxBar = document.getElementById("chartByState").getContext("2d");
		var myBarChart = new Chart(ctxBar).Bar(initialData, {barShowStroke: false});
		polosPorEstado(myBarChart);

		//for pie graph
		var ctx = document.getElementById("chartByRegion").getContext("2d");
    var myPieChart = new Chart(ctx).Pie(dadosChart);


}

</script>

</body>

</html>
