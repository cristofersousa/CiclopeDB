<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<title>Mapa dos Pólos UAB</title>
	<meta charset="utf-8">
	<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
	<link rel="stylesheet" href="ipes.css" />
	<script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<script src="ipes-all.json" type="text/javascript"></script>

<script src=" https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>


	<style type="text/css" charset="utf-8">
		#map {
			height: 500px;
			margin-left:auto;
			margin-right:auto;
			width:50%;
			border-style: solid;
			border-color: #555;
			border-width: 5px;
			-moz-border-radius: 10px;
			border-radius: 10px;
		}
	</style>
</head>
<body>

	<div id="map"></div><br>

	<script>
	regioes = {
    "AC" : "Norte",
    "AL" : "Nordeste",
    "AP" : "Norte",
    "AM" : "Norte",
    "BA" : "Nordeste",
    "CE"  : "Nordeste",
    "DF"  : "Centro-Oeste",
    "ES"  : "Sudeste",
    "GO"  : "Centro-Oeste",
    "MA"  : "Nordeste",
    "MS"  : "Centro-Oeste",
    "MT"  : "Centro-Oeste",
    "MG"  : "Sudeste",
    "PA"  : "Norte",
    "PB"  : "Nordeste",
    "PR"  : "Sul",
    "PE"  : "Nordeste",
    "PI"  : "Nordeste",
    "RJ"  : "Sudeste",
    "RN"  : "Nordeste",
    "RS"  : "Sul",
    "RO"  : "Norte",
    "RR"  : "Norte",
    "SC"  : "Sul",
    "SP"  : "Sudeste",
    "SE"  : "Nordeste",
    "TO"  : "Norte"}


	//Cores para serem usadas no chart
	Colors = {};
	Colors.names = {
	  blue: "#AEC6CF",
	  brown: "#836953",
	  darkblue: "#779ECB",
	  darkcyan: "#008b8b",
	  darkgrey: "#CFCFC4",
	  darkgreen: "#006400",
	  darkkhaki: "#bdb76b",
	  darkolivegreen: "#556b2f",
	  darkorange: "#C46210",
	  darkorchid: "#9932cc",
	  darkred: "#8b0000",
	  darksalmon: "#e9967a",
	  gold: "#ffd700",
	  mantisgreen: "#74C365",
	  indigo: "#4b0082",
	  pastelblue: "#73A9C2",
	  pastelgreen: "#77DD77",
	  lightgrey: "#696969",
	  pastelpurple: "#B39EB5",
	  maroon: "#800000",
	  navy: "#000080",
	  olive: "#808000",
	  pastelorange: "#FFB347",
	  purple: "#800080",
	  violet: "#CB99C9",
	  rubyred: "#9B111E",
	  yellow: "#ffff00"
	};

	Colors.random = function() {
	  var result = 0;
	  var count = 0;
	  for (var prop in this.names)
	      if ( (Math.random() < 1/++count) && (result === 0)) {
	         result = this.names[prop];
	         delete this.names[prop];
	       }

	  return result;
	};


	var base = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
	  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	  });

	var brasil = L.geoJson(null, {
		style: {
			weight: 1,
			color: "#fff",
			opacity: 1,
			fillColor: "#ccc",
			fillOpacity: 1
			}
			});
			$.getJSON("br_estados.json", function(data) {
				brasil.addData(data);
			});


	var polosRegiao = {};
	var dadosChart = [];

	var ipes = L.geoJson(null, {onEachFeature: onEachFeature, pointToLayer: pointToLayer});
	$.getJSON("ipes-all.json", function (data) {
	  ipes.addData(data);

		//Todo esse código abaixo é necessário para se gerar o gráfico de pizza

		$.each(data.features, function (key, val) {
			//se não existe esse estado na lista cria
			if (!(regioes[val.properties.Estado] in polosRegiao)) {
				polosRegiao[regioes[val.properties.Estado]] = 1;
			} else {
				//se existe, soma ao valor
				polosRegiao[regioes[val.properties.Estado]] ++ ;
			}

		});

		$.each(polosRegiao, function (regiao, qtde) {
			dadosChart.push({
				"label": regiao,
				"value": qtde,
				"color": Colors.random()
			});
		});

	});


//Versão polos por estado em pizza
	function polosPorEstado (myBarChart){
		var polosEstado = {};

		$.getJSON("ipes-all.json", function (data) {
			$.each(data.features, function (key, val) {
				//se não existe esse estado na lista cria
				if (!(val.properties.Estado in polosEstado)) {
					polosEstado[val.properties.Estado] = 1;
				}else {
					//se existe, soma ao valor
					polosEstado[val.properties.Estado] ++ ;
				}

			});

			//sorting the polos
			var polosOrdenados = [];
			for (var polo in polosEstado)
			      polosOrdenados.push([polo, polosEstado[polo]])
			polosOrdenados.sort(function(a, b) {return b[1] - a[1]})
			//polosOrdenados = [[estado,qtde],...]

			for (i = 0; i < polosOrdenados.length; i++) {
		    myBarChart.addData([polosOrdenados[i][1]],polosOrdenados[i][0]);
			}

			// $.each(polosEstado, function (estado, qtde) {
			// 	myBarChart.addData([qtde],estado);
			// });
			myBarChart.update();

		});
}




  function onEachFeature (feature, marker) {
		if (feature.properties) {
			marker.bindPopup(
				'<b>' + feature.properties.Sigla + '</b>' + '<br>' +
				feature.properties.Cidade + ', ' + feature.properties.Estado + '</br>' +
				feature.properties.Logradouro + ' - ' + feature.properties.Bairro + '</br>' +
				feature.properties.CEP + '</br>' +
				'Telefone :' + feature.properties.Telefone + '</br>' +
				'<a href="' + feature.properties.URL + '">' + feature.properties.URL + '</a>'
			)
		}
	};

	function pointToLayer (feature, latlng) {
		 return L.circleMarker(latlng, {
			 radius: 6,
			 fillColor: "#267FCA", color: "#000",
			 weight: 1,
			 opacity: 1,
			 fillOpacity: 0.3
		 });
	 };

var map = L.map('map', {layers: [base,ipes]}).setView(new L.LatLng(-14.953349393643416,-52.220703125),4);

var baseMaps = {"Mapa": brasil};
var overlayMaps = {
	"Brasil" :brasil,
	"IPES" : ipes
};

//Ordem de camadas de vetores só será resolvida no Leaflet v1.0. Por isso a camada das
//zIndex() e bringToFront() não funcionam com vetores.
//Confirmado problema. Verificar também: http://gis.stackexchange.com/questions/166252/geojson-layer-order-in-leaflet-0-7-5
L.control.layers(baseMaps, overlayMaps,{position: 'topleft'}).addTo(map);
</script>

<div class= "graph">
<h2>Número de IPES por Estado</h2>
<!-- Gráfico de Barras-->
<canvas id="chartByState" width="800" height="300"></canvas>

<h2>Número de IPES por Região</h2>
<!--O código à seguir também é necessário para o gráfico de pizza -->
<canvas id="chartByRegion"></canvas>
</div>

<script>

window.onload = function(){
		//for bar grpah
		initialData = {
			labels : [],
			datasets :[{
				fillColor: "blue",
				data :[]
			}]

		};
		var ctxBar = document.getElementById("chartByState").getContext("2d");
		var myBarChart = new Chart(ctxBar).Bar(initialData, {barShowStroke: false});
		polosPorEstado(myBarChart);

		//for pie graph
		var options =
	  {
				//animation: false;

	      tooltipTemplate: "<%if (label){%><%=label%>: <%}%><%= value %>",

	      onAnimationComplete: function()
	      {
	          this.showTooltip(this.segments, true);
	      },

	      tooltipEvents: [],

	      showTooltips: true
	  }

		var ctx = document.getElementById("chartByRegion").getContext("2d");
    var myPieChart = new Chart(ctx).Pie(dadosChart,options);


}

</script>

</body>

</html>
